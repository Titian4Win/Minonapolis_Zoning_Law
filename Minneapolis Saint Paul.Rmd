---
title: "Minneapolis Saint Paul"
author: "Andrew Bradbury"
date: "2023-03-04"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Data
## The data used in this analysis is sourced from a dataset that includes information on all real estate transactions that took place in the Twin Cities metro area from 2016-2021. The data was originally sourced from the Minnesota Department of Revenue and cleaned by the author.

```{r}
setwd('/Users/andrewscpu/Documents/GitHub/Titian4Win.github.io')
#install packages
#install.packages("dplyr")
#install.packages("readr")
#install.packages("tidyverse")
#install.packages("modelsummary")
#install.packages("fixest")
#install.packages("foreign")
#install.packages("lubridate")
#install.packages("AER")
#install.packages("stargazer")
#install.packages("zoo")
#install.packages("ggplot2")
#install.packages("readr")
#install.packages("data.table")
#install.packages("skimr")
#install.packages("scales")
#install.packages("Ecdat")
#install.packages("here")
#library(Ecdat)
# Load libraries
library(tidyverse)
library(modelsummary)
library(AER)
library(fixest)
library(lubridate)
library(scales)
library(skimr)
library(here)
library(skimr)
library(scales)
library(ggplot2)
library(modelsummary)
library(AER)
library(stargazer)
library(fixest)
library(dplyr)
library(readr)
library(tidyverse)
library(foreign)
library(lubridate)
library(zoo)
library(readr)
library(data.table)
```
###### Filter & Name Cities
```{r}
# Load data
minneapolis_saint_paul <- fread("/Users/andrewscpu/Documents/GitHub/Titian4Win.github.io/Minneapolis_Saint_Paul.csv")
# Filter & rename cities
saint_paul <- minneapolis_saint_paul %>% 
  filter(cty_twnshp_nme == "St. Paul") %>% 
  rename(purchase_price = tot_purch_amt)

minneapolis <- minneapolis_saint_paul %>% 
  filter(cty_twnshp_nme == "Minneapolis") %>% 
  rename(purchase_price = tot_purch_amt)

# Convert dates to year-quarter format
saint_paul <- saint_paul %>% 
  mutate(date = as.yearqtr(dates, format = "%Y-Q%"))

minneapolis <- minneapolis %>% 
  mutate(date = as.yearqtr(dates, format = "%Y-Q%"))
```

# Preprocessing
```{r}
# Cap sales amount at two standard deviations away from the mean, $1,550,045
saint_paul <- saint_paul %>% 
  mutate(purchase_price = pmin(purchase_price, mean(purchase_price) + 2 * sd(purchase_price), 1550045))

minneapolis <- minneapolis %>% 
  mutate(purchase_price = pmin(purchase_price, mean(purchase_price) + 2 * sd(purchase_price), 1550045))

# Calculate quarterly aggregate means
saint_paul_agg <- saint_paul %>% 
  group_by(date) %>% 
  summarize(mean_purchase_price = mean(purchase_price))

minneapolis_agg <- minneapolis %>% 
  group_by(date) %>% 
  summarize(mean_purchase_price = mean(purchase_price))
```
###### Create quarterly aggregate means
```{r}
# Create quarterly aggregate means
aggregated_data_M <- aggregate(tot_purch_amt ~ dates, data = Minneapolis, FUN = mean)
aggregated_data_SP <- aggregate(tot_purch_amt ~ dates, data = Saint_Paul, FUN = mean)
aggregated_data_SPM <- aggregate(tot_purch_amt ~ dates, data = Minneapolis_Saint_Paul, FUN = mean)
```
## Graph of Minneapolis
```{r}
# Rename columns
colnames(aggregated_data_M) <- c("dates", "M")
colnames(aggregated_data_SP) <- c("dates", "SP")

# Merge data frames
MSP <- merge(aggregated_data_M, aggregated_data_SP, by = "dates")

# Create plot
p <- ggplot(aggregated_data_M, aes(x = dates, y = M)) + 
  geom_point(color = "black") +
  geom_line(color = "red", linetype = "dashed") +
  labs(title = "Minneapolis", x = "Year", y = "Mean Transaction Price (in millions)") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  scale_y_continuous(labels = label_number(suffix = "M", scale = 1e-6))

# Add points to plot
p <- p + geom_point(data = MSP, aes(x = dates, y = SP), color = "blue")
plot(p)
```

###### Graph of Saint Paul
```{r}
# Create plot
p <- ggplot(aggregated_data_SP, aes(x = dates, y = SP)) + 
  geom_point(color = "black") +
  geom_line(color = "blue", linetype = "dashed") +
  labs(title = "Saint Paul", x = "Year", y = "Mean Transaction Price (in millions)") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  scale_y_continuous(labels = label_number(suffix = "M", scale = 1e-6))

# Add points to plot
p <- p + geom_point(data = MSP, aes(x = dates, y = M), color = "red")
plot(p)
```

###### Summary Statistics
```{r}
# Display summary statistics
skimr::skim(aggregated_data_M)
skimr::skim(aggregated_data_SP)
```
###### New file with converted dates, not shown
```{r}
# Read data from file
Book1 <- fread("/Users/andrewscpu/Documents/GitHub/Titian4Win.github.io/Book1.csv")
```
###### Treatment period from 2019-2021 (Period after announcement)
```{r}
# Create binary variable indicating treated observations
Book1 <- Book1 %>%
  mutate(Treated = cty_twnshp_name == "M" & 
           quarter %in% c("2019 Q1", "2019 Q2", "2019 Q3", "2019 Q4", "2020 Q1", "2020 Q2", "2020 Q3", "2020 Q4", "2021 Q1", "2021 Q2", "2021 Q3", "2021 Q4"))
```
###### Estimate the regression with fixed effects by state and quarter
###### The estimate for banning single-family zoning laws was $33,272.15
```{r}
clfe <- feols(tot_purch_amt ~ Treated | cty_twnshp_name + quarter, data = Book1)
msummary(clfe, stars = c('*' = .1, '**' = .05, '***' = .01))
```
###### Use only Pretreatment data (before announcement) (placebo tests)
###### Shows the placebo tests that happen in the two quarters leading up to the policy change. 
###### Placebo test with a fake treatment one that represents the interaction between Q2 2018 and Q3 2018, which passes the placebo test and shows that results hold at the five percent level. 
###### Fake treatment two represents the transaction just in Q3 2018. The results of this period were insignificant
```{r}
Book1 <- Book1 %>% 
  filter(quarter >= "2015 Q2" & quarter <= "2017 Q2") %>% 
  mutate(FakeTreat1 = cty_twnshp_name == "M" &
           quarter %in% c('2018 Q2', '2018 Q3'),
         FakeTreat2 = cty_twnshp_name == "M" &
           quarter == '2018 Q3')
# Run the same model we did before but with our fake treatment
clfel1 <- feols(tot_purch_amt ~ FakeTreat1,
               data = Book1)
clfel2 <- feols(tot_purch_amt ~ FakeTreat2,
               data = Book1)
msummary(list(clfel1, clfel2), stars = c('*' = .1, '**' = .05, '***' =.01))
```
